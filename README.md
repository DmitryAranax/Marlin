# Marlin для Fliyng Bear 5 с интерфейсом MKS UI

Это форк bugfix ветки Marlin с включенным графическим интерфейсом от компании MKS. Изменения внесены только в файлы конфигурации.

Ветка bugfix используется из-за того, что код работы с wifi модулем пока не добавлен в основную ветку.

Настройки направления движения осей сделаны для принтера FB5 в стандартной конфигурации. Если вам нужно изменить направление, сделать это можно в файле Marlin/Configuration.h (строка 1127):

```
#define INVERT_X_DIR false
#define INVERT_Y_DIR false
#define INVERT_Z_DIR false

// @section extruder

// For direct drive extruder v9 set to true, for geared extruder set to false.
#define INVERT_E0_DIR false

```

## Датчик окончания филамента

Обработка датчика окончания филамента происходит внутри MKS UI, поскольку требуется взаимодействие с экраном (постановка на паузу, обработка нажатия на кнопку "продолжить"). Поэтому стандартная функция Marlin FILAMENT_RUNOUT_SENSOR в Configuration.h выключена. 
На принтерах FB4S и FB5 разная логика работы датчика, поэтому нужно установить нужную настройку для вашего принтера. В файле Marlin/src/pins/stm32f1/pins_MKS_ROBIN_NANO.h параметр MT_DET_PIN_INVERTING:

```
#define MT_DET_PIN_INVERTING             true  // LVGL UI filament RUNOUT PIN STATE
```

Для FB5 значение параметра "true", для FB4S значение параметра "false".
Если датчик филамента настроен не верно, то при запуске печати принтер будет вставать на паузу.

### Диагностика работы датчика.

Для проверки работы датчика в файле Marlin/src/lcd/extui/lib/mks_ui/printer_operation.cpp можно включить вывод отладочных сообщений. В строке 168 и 169 нужно убрать комментарий:

```
SERIAL_ECHO("; filament check: ");
SERIAL_ECHOLN(fil_det_count_1);
```

В терминал будут выводится сообщения с значением счетчика:

```
; filament check: 0
```

При срабатывании датчика филамента, при каждом опросе состояния принтера счетчик будет увеличиваться. В случае если он достингнет 20, принтер встанет на паузу. Сделано это для борьбы с случайными срабатываниями.

## Сборка, прошивка

Плата robin nano v1.*, которая установлена в принтерах FB5 и FB4S, уже выбрана в настройках platformio. Для сборки достаточно нажать Ctrl+Alt+B. В некоторых случаях, при первой попытке скомпилировать прошивку возникают ошибки. В таком случае, нужно нажать на значок platformio (инопланетянин), в разделе Project tasks выбрать Default -> General -> Clean All. После этого попробовать собрать еще раз.

После успешной сборки, прошивка находится в папке .pio/build/mks_robin_nano35 На sd карту нужно скопировать файл Robin_nano35.bin а так же папку assets (в ней содержатся картинки и шрифты).
